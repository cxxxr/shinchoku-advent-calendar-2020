# Koto - ファイルシステムをシンセサイザーにする

この記事は[進捗 Advent Calendar 2020](https://github.com/t-sin/shinchoku-advent-calendar-2020)の1日目の記事です。

## ごあいさつ

t-sinです。エタったり途中だったりする進捗を雑に紹介するアドベントカレンダー、始まりました。「雑に」というのは「きちっとした記事になってなくていい」くらいの意味あいです。ぜんぶ埋めなくてもいいくらいの気持ちでゆったりやっていきます。

今日は、まだどこでも話したり記事にしていないものとして[Koto](https://github.com/t-sin/koto)のことを書きます。

## Kotoとはどんなものか

Kotoはファイルシステムをユーザーインターフェースとする音楽演奏環境です。起動時に指定したディレクトリに音信号モジュールを対応づけ、ファイルやディレクトリへの操作が音信号モジュールのオブジェクトを操作することに対応させます。そうすることで、bashなどのコマンドラインシェルやNautilusなどのGUIのファイルマネージャ等を通じて音信号モジュールのパラメータや構成を変更し、音をリアルタイムに、インタラクディブに変更していくことができます。ファイルシステムと音信号モジュールを対応づけるために内部でFUSEを用いているためGNU/Linuxとmac OSでしか動きません (mac OSでの動作は未確認)。

Kotoには音信号処理をする基本的なモジュールをいくつか用意してあり、それらを組み合わせて多少複雑な音作りをすることができます。モジュールには以下のようなものがあります:

- オシレータ: サイン波などの信号を出力するモジュール
- シーケンサ関連: 時間軸上のイベントスケジューリング用のモジュールたち
  - ADSRエンベロープジェネレータ (EG): 音量の変化を表わす信号を出力するモジュール
  - トリガー: シーケンサのエンベロープ信号を複数のEGに分配するモジュール
  - シーケンサ: MMLっぽい記法で指定された音の発音タイミングや音階を基にEGやオシレータをコントロールするモジュール
- エフェクト: 入力信号を変化させるモジュールたち
  - ローパスフィルタ: 入力の高周波域をパラメータに応じてカットするモジュール
  - ディレイ: 入力を遅延させるモジュール
- ユーティリティ: 信号同士の演算をしたり、音量や[パン](https://ja.wikipedia.org/wiki/%E3%83%91%E3%83%B3%E3%83%8B%E3%83%B3%E3%82%B0_(%E9%9F%B3%E9%9F%BF))を変更するモジュール

メロディを複数並列で鳴らすことはもちろんできますが、オシレータの入力をローパスフィルタのカットオフ周波数に繋いでオートワウみたいなことをしたり、EGとフィルタを組み合わせてエンベロープフィルタのようなことをしたり、といったことがえきます。以下にKotoを使ってリアルタイムでライブパフォーマンスっぽいことをしている動画を置いておきます。

https://www.youtube.com/watch?v=Rxh-msWrj6o

音信号処理のコア部分はKotoでやっている「ファイルシステムと音信号処理の融合」以外にも使いたくなりそうだったので、[Tapirus](https://github.com/t-sin/tapirus)というクレートに切り出してあります。用いているオーディオAPI抽象化ライブラリがWeb Audio APIをバックエンドに対応していたので、UIはReactとかでつくってブラウザで動かすとかできるのではないかしら、と踏んだためです。

Kotoでは音信号モジュールの構成をダンプしたりロードしたりすることができるのですが、そのダンプの表現に簡単なLisp処理系を実装して利用しています。これによって演奏中の状態をファイルに出力して保存しておく、ということができます (実はKotoのマウントしているディレクトリをまるごとコピーすればそれでOKなのですが…)。

## なぜつくったのか

Kotoはシェル芸で音楽のライブパフォーマンスをするためにつくりました。ふと「ファイルにノードのパラメータがマップされてて、そこをシェル芸で操作して音楽奏でればよくね」というアイデアが降臨したためです。

そのネタを思い付いたとき (たぶん2018年ごろ) はちょうどモジュラーシンセサイザーのことや、GPUのシェーダ言語や音楽言語を用いたライブコーディングという分野を知り、いろいろ調べていた時期でした。そしてまた、シェル芸botをフォローするなどしてシェル芸界隈を遠くから眺めてもいました。ぼくが使うDAW (Digital Audio Workstation) の[Bitwig Studio](https://www.bitwig.com/)の内部構造を考えたりしていたことも影響していたのでしょう。複数の信号処理ブロックを繋げてマルチトラックの音声処理を実現しようとすると、基本的には、スピーカー (最終出力点) を根とする木構造のかたちにブロックを繋げることになります。実際[PureData](https://ja.wikipedia.org/wiki/Pure_Data)や[GPLv3でライセンスされたDAW Zrythmのソースコード](https://docs.zrythm.org/graph_8h.html#!)、あるいは[Web Audio APIのAudioNode](https://developer.mozilla.org/en-US/docs/Web/API/Web_Audio_API)なども信号処理ノードのグラフというキーワードが登場するので、わりと一般的な考えのようです。これらの思索が合体した結果がシェル芸音楽ライブパフォーマンスであったというわけです。

実装にはRustを用いました。理由は、バイナリを手軽に配布したかったのとRustでプログラムを書いてみたかったからです。最初は[Nim](https://nim-lang.org/)で実装を進めていましたがコンパイラのバグを踏んで実装が止まったので、元からRustに興味があったしちょうどよい機会だなとRustにさっさと移行しました。

## 現状

Kotoは、最初考えていた機能をすべて実装したような気がしたため2020年2月19日にv1.0.0になりました。その時点でいったんやる気が尽き放置していました。Kotoのv1.0.0にはシーケンサに「長いメロディを演奏させると正しく演奏されない」というバグがあったのですが、今年の8月に修正しました (そういえば未リリース)。その後、Kotoでパフォーマンスをすると最初はひたすらディレクトリやファイルをつくりまくらねばならないので無音状態が続く問題 (先に示した動画を見るとわかる)に対処するべく楽にする用のシェルスクリプトを足したりしていました。

最新のKoto/Tapirusでは、WAVファイルの再生に対応しました。Kotoにはもともとテーブルの走査位置をオシレータで指定可能な波形テーブルオシレータがあったのですが、こいつにsoxコマンドを用いて適切にWAVファイルを変換することで、事前に用意したWAV音源を再生することができるようになっています。

書いていて思うに、もうちょっとなんとかすると曲作りができそうな感じがしてきました。

## 苦労したところ

Kotoはぼくが挑戦した音信号処理プログラムとしては2個目のものになります。1個目は[Pukunui](https://github.com/t-sin/pukunui)といってCommon Lispで実装している実験的なものです。まだ音プログラミング経験が浅いのでいろいろな点で苦労しました。

- シーケンサの実装方法をちゃんと考えたことがなかったので、よく詰まった
- Rustはじめてだったので、コンパイルエラーに悩まされまくった
- 手探りでつくっていたためコンパイラに怒られるような型にしてしまい、育ってから何度か型をすべて書き直した
- FUSEの仕様や使い方の理解に時間がかかった
- マルチスレッドプログラミングをはじめてやったので (FUSEスレッドと音処理スレッド)、デッドロックに悩まされた

Rustに関していうと、ぼくはライフタイム関連のコンパイルエラーに悩まされた後にとりあえずBoxで書くことで逃げていました。あるいはそれが正しいデータ型の形だったのかもしれないですが。

## コトさん

Twitterで開発過程を見ていた方はわかると思いますが、Kotoとは[東武動物公園にいるマレーバク](http://www.tobuzoo.com/zoo/list/details/34/)の[コトさん](https://twitter.com/tobuzoo7/status/1021623019465146368)のことです。2018年の3月17日生まれのメスのマレーバクで、ぼくがカメラを持って動物園に行きだしたくらいのころに生まれた個体です。コトさんやマレーバクが好きなので、Kotoを知ることでマレーバクについて知るきっかけになったらうれしいなあと思ってつけたのでした。

そういえば、KotoのGitHubリポジトリのREADMEや[公式サイト](https://t-sin.github.io/koto/)にあるロゴ画像がコトさんなのでした。コトさんはお茶目で好奇心旺盛で、放飼場前の柵に前足を乗っけていたり、母親のシンディーさんと同じくよく柵を齧っていたりします。そんなお茶目さが伝わっているとよいのですが。

## おわりに、あるいは今後のこと

そういえばパフォーマンス時に初期設定をして無音状態が長い問題について思いだしたことがありました。2ヶ月くらい前に[二水_茶箱](https://ni-sui.electribe.jp)で[パリピデストロイヤー](https://www.digilog.tokyo/products/paripidestroyer)の作者の方とお話する機会があったときにこの問題のことを話に出したところ「それはパフォーマンス時に(楽器の)木を切り出し始めるようなものですね」という言葉をいただきました。たしかに無音長い問題は、商用リリース時にコーディングを開始するような、なんというか準備を本番でしているため発生している問題なのだなあと感銘を受けたのを記憶しています。よし、解決！

今後どうしていこうかは悩んでいますが、まだ途中の作業に区切りをつけて曲作りやパフォーマンスに使ってみて発表とかしてみるとよいのかなあという感じです。

Kotoについて語るのはこのへんにしておきます。
