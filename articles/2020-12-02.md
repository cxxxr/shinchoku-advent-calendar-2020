# 関数型弾幕言語と疑似PostScriptインタプリタ

この記事は[進捗 Advent Calendar 2020](https://github.com/t-sin/shinchoku-advent-calendar-2020)の2日目の記事です。

## 関数型弾幕言語ってなに？

ひとことで言えば「弾幕コンビネータ」です。弾幕コンビネータを目指したもの、です。リポジトリは[こちら](https://github.com/t-sin/glider)。ジェネラティブアートみのある弾幕シューティング言語をつくってみようとしたものです。弾幕というと[巫女さんがやる](https://www16.big.or.jp/~zun/top.html)ものであったり[死ぬがよい](https://www.youtube.com/watch?v=j9e9Imn3xZU&t=90)ものであったり、[ケツイするもの](https://www.youtube.com/watch?v=PWnY4XrWVYQ&t=1898)であったりします。こういう弾幕をぼくも出してみたい (書いてみたい) とかねがね思っていました。そしてぼくはLispが好きだったのでLispらしいアプローチを取ってみたかったのです。

そこで、Gliderと名前をつけたシューティングゲームの弾幕記述フレームワークとしてこの弾幕コンビネータフレームワークをつくりました。エタっていません。まだつくる気はあるからエタっていません。

[動かしている動画](https://twitter.com/sin_clav/status/1133793872050417665)がありました。現在のmasterでも同じ動きをするはずです。

以下のコード

```lisp
;; https://github.com/t-sin/glider/blob/c9878f22dbe0ba60589e82e30f32750727c11ace/src/scenes/shooter.lisp#L65
(defun make-event ()
  `((0 . (:fire ,(/ *shooter-width* 2) 100
          ,($when (%count-n? 2)
                  ($times ($fire ($progn ($move (%move-2 #'cos (%rotate 72) 1 14)
                                                (%move-2 #'sin (%rotate 72) 1 14))
                                         ($when (%out-of? 0 0 *shooter-width* *shooter-height*)
                                                ($disable))))
                          5))
          ,#'default-drawer))
  ...))
```

の2行目の`(0 . (:fire ...))`が「0フレーム目に`(:fire ...)`のイベントを発火させる」という意味で、`:fire`は「弾を打つ」あるいは「オブジェクトを置く」ための弾幕スケジューラのイベントです。`:fire`をよくみると4引数の関数っぽくなっていて`(:fire 初期位置X 初期位置Y 動きを記述する関数オブジェクト 描画関数)`となっています。`$`から始まっている関数名は弾幕フレームワークのビルトイン関数で、関数を返す関数になっています。たとえば`$when`だと1つめの関数を実行した結果が`t`なら2つめの関数を実行する、というようなぐあいです。`%`から始まっているのは、このファイル内で定義したユーティリティ関数です。フレーム数をカウントしたり (`%count-n?`)、移動 (`%move-2`) や移動ベクトルの回転 (`%rotate`) を記述したり、という関数です。久しぶりにコードを見てみましたが昔のことなので詳細がよくわかりませんでした。

## 疑似PostScriptインタプリタって？

Gliderのグラフィックス部分を作ろうとしたときにグラフィクスのデータをベクタデータにしようと思いました。ワイヤーフレーム的な見た目にしようとしていたのです。そこで数字を直接いじってベクタデータをつくっていたのですがつらすぎたので、Inkscapeでつくったベクタデータを使いたくなりました。しかしSVGはなんかよくわかない。そういえば[ちょっと前にPostScriptを書いて遊んでたりした気がする](https://twitter.com/sin_clav/status/1114538156160774145)。そうだ、PostScirptで出力して点データを抜き取ればいいんだ。そういう過程を経て生まれたのが[疑似PostScriptインタプリタ PPS](https://github.com/t-sin/glider/blob/c9878f22dbe0ba60589e82e30f32750727c11ace/src/tools/pps.lisp)です。

こちらも[動作させたときの画像](https://twitter.com/sin_clav/status/1134719588560658433)がありました。ご査収ください。

## 現状

さて現状ですが、実際にグラフィックをつくるところでストップしています。というより、フレームワークというか下地をつくるのに夢中になりすぎて、上に乗っけるゲーム自体のことをあまり考えていなかったからというのがホントのところでしょう。あと、[Monadius](https://github.com/tanakh/monadius)のようなグラフィックを指向したため工数がふくれあがったというのもあります。初心者のうちはまず簡単な内容にするのがいいでしょう。

ちなみにGliderはエタっていません。まだつくる気はあるからエタっていません。

## 苦労したところ

無名関数をもりもりと使うので、デバッグがとてもつらかった記憶があります。関数を実行しないとエラーがわからないしスタックトレースには関数名がでませんのですごくつらい目にあったことは容易に想像できると思います。

ですがなによりもまず、弾幕を記述するということがどういうことだかつくり始めたときはわかっていなかったので、どういうコンビネータを用意すればいいのか手探りでした。いちおう[ソースコードを見る](https://github.com/t-sin/glider/blob/c9878f22dbe0ba60589e82e30f32750727c11ace/src/shooter/combinators.lisp)と、これくらいあればだいたいの弾幕は張れそうというような要素は抽出できていたようです。複雑な弾幕を記述するとなると道具が不足しているかもしれませんが動画のような弾幕は張れるので、突き詰めてみるとおもしろいなと思っています。

## おわりに

今みるとけっこうおもしろそうなことやってたんですね。
